<view class="container"><view class="search-bar"><view class="search-input"><text class="iconfont icon-search"></text><input type="text" placeholder="搜索店内商品" data-event-opts="{{[['input',[['__set_model',['','searchKeyword','$event',[]]],['searchProducts',['$event']]]]]}}" value="{{searchKeyword}}" bindinput="__e"/><block wx:if="{{searchKeyword}}"><text data-event-opts="{{[['tap',[['clearSearch',['$event']]]]]}}" class="clear-icon" bindtap="__e">×</text></block></view><view data-event-opts="{{[['tap',[['goToMerchant',['$event']]]]]}}" class="merchant-entry" bindtap="__e"><text>商家</text><image class="merchant-icon" src="/static/products/fangzi.png" mode="aspectFit"></image></view></view><view class="brand-filter"><view class="brand-label">品牌：</view><scroll-view class="brand-scroll" scroll-x="{{true}}"><view class="brand-list"><block wx:for="{{brands}}" wx:for-item="brand" wx:for-index="__i0__" wx:key="id"><view data-event-opts="{{[['tap',[['selectBrand',['$0'],[[['brands','id',brand.id,'id']]]]]]]}}" class="{{['brand-item',(selectedBrand===brand.id)?'active':'']}}" bindtap="__e">{{''+brand.name+''}}</view></block></view></scroll-view></view><block wx:if="{{isSearching}}"><view class="search-results-container"><scroll-view class="search-results" style="height:calc(100vh - 200rpx);" scroll-y="{{true}}" refresher-enabled="{{true}}" refresher-triggered="{{refreshing}}" data-event-opts="{{[['scrolltolower',[['onReachBottom',['$event']]]],['refresherrefresh',[['onSearchRefresh',['$event']]]]]}}" bindscrolltolower="__e" bindrefresherrefresh="__e"><block wx:for="{{$root.l0}}" wx:for-item="item" wx:for-index="index" wx:key="id"><view data-event-opts="{{[['tap',[['goToDetail',['$0','$1','$2'],[[['searchResults','id',item.$orig.id]],[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]]]}}" class="product-item" bindtap="__e"><image src="{{item.$orig.image}}" mode="aspectFit"></image><view class="product-info"><view class="product-info-top"><text class="product-name">{{item.$orig.name}}</text><text class="product-stock">{{"库存"+item.$orig.stock}}</text></view><view class="product-price-wrap"><text class="price">{{"￥"+item.$orig.price+"/件"}}</text><block wx:if="{{item.m0}}"><view class="quantity-control my-quantity-control"><text data-event-opts="{{[['tap',[['removeFromCart',['$0','$1'],[[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]]]}}" class="minus" catchtap="__e">-</text><input class="num" type="digit" data-event-opts="{{[['input',[['handleQuantityInput',['$event','$0','$1'],[[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]],['blur',[['handleQuantityBlur',['$0','$1'],[[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]],['tap',[['',['$event']]]]]}}" value="{{item.m1}}" bindinput="__e" bindblur="__e" catchtap="__e"/><text data-event-opts="{{[['tap',[['handleAddToCart',['$0','$1','$event'],[[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]]]}}" class="{{['plus',(item.m2)?'disabled':'']}}" catchtap="__e">+</text></view></block><block wx:else><text data-event-opts="{{[['tap',[['handleAddToCart',['$0','$1','$event'],[[['searchResults','id',item.$orig.id,'categoryIndex']],[['searchResults','id',item.$orig.id,'productIndex']]]]]]]}}" class="{{['add-btn',(item.m3)?'disabled':'']}}" catchtap="__e">+</text></block></view></view></view></block><block wx:if="{{loading}}"><view class="loading-more">加载中...</view></block><block wx:if="{{!hasMore}}"><view class="no-more">更多了</view></block></scroll-view></view></block><block wx:else><view class="main-content"><scroll-view class="category-list" scroll-y="{{true}}"><block wx:for="{{categories}}" wx:for-item="category" wx:for-index="index" wx:key="id"><view data-event-opts="{{[['tap',[['switchCategory',[index]]]]]}}" class="{{['category-item',(currentCategory===index)?'active':'']}}" bindtap="__e">{{''+category.name+''}}</view></block></scroll-view><scroll-view class="product-list" style="height:100%;" scroll-y="{{true}}" scroll-top="{{scrollTop}}" scroll-with-animation="{{false}}" data-event-opts="{{[['scroll',[['onProductScroll',['$event']]]]]}}" bindscroll="__e"><block wx:for="{{$root.l2}}" wx:for-item="category" wx:for-index="categoryIndex" wx:key="id"><view class="category-wrapper"><view class="category-section-title">{{''+category.$orig.name+''}}</view><view class="product-items"><block wx:for="{{category.l1}}" wx:for-item="item" wx:for-index="index" wx:key="id"><view data-event-opts="{{[['tap',[['goToDetail',['$0',categoryIndex,index],[[['filteredCategories','id',category.$orig.id],['items','id',item.$orig.id]]]]]]]}}" class="product-item" bindtap="__e"><image src="{{item.$orig.image}}" mode="aspectFit"></image><view class="product-info"><view class="product-info-top"><text class="product-name">{{item.$orig.name}}</text><text class="product-stock">{{"库存"+item.$orig.stock}}</text></view><view class="product-price-wrap"><text class="price">{{"￥"+item.$orig.price+"/件"}}</text><block wx:if="{{item.m4}}"><view class="quantity-control"><text data-event-opts="{{[['tap',[['removeFromCart',[categoryIndex,index]]]]]}}" class="minus" catchtap="__e">-</text><input class="num" type="digit" data-event-opts="{{[['input',[['handleQuantityInput',['$event',categoryIndex,index]]]],['blur',[['handleQuantityBlur',[categoryIndex,index]]]],['tap',[['',['$event']]]]]}}" value="{{item.m5}}" bindinput="__e" bindblur="__e" catchtap="__e"/><text data-event-opts="{{[['tap',[['handleAddToCart',[categoryIndex,index,'$event']]]]]}}" class="{{['plus',(item.m6)?'disabled':'']}}" catchtap="__e">+</text></view></block><block wx:else><text data-event-opts="{{[['tap',[['handleAddToCart',[categoryIndex,index,'$event']]]]]}}" class="{{['add-btn','my-add-btn',(item.m7)?'disabled':'']}}" catchtap="__e">+</text></block></view></view></view></block></view></view></block></scroll-view></view></block><view class="cart-bar"><view class="cart-left"><view class="message-wrap"><image class="message-image" src="/static/products/wenshangjai.png" mode="aspectFit"></image><text class="message-text">问商家</text></view><view data-event-opts="{{[['tap',[['showCart',['$event']]]]]}}" class="cart-wrap" bindtap="__e"><view class="cart-icon" animation="{{cartAnimation}}"><image class="cart-image" src="/static/products/cart.png" mode="aspectFit"></image><block wx:if="{{cartCount}}"><text class="cart-badge">{{cartCount}}</text></block></view><text class="cart-text">购物车</text></view></view><view class="cart-right"><text class="total-price">{{"￥"+totalPrice}}</text><view data-event-opts="{{[['tap',[['goToCheckout',['$event']]]]]}}" class="{{['checkout-btn',(cartCount===0)?'disabled':'']}}" bindtap="__e">去结算</view></view></view><block wx:if="{{showCartPopup}}"><view class="cart-popup"><view data-event-opts="{{[['tap',[['hideCart',['$event']]]]]}}" class="cart-mask" bindtap="__e"></view><view class="cart-content"><view class="cart-header"><view class="header-left"><text class="title">购车</text><block wx:if="{{cartCount}}"><text class="cart-count">{{"(共"+cartCount+"件商品)"}}</text></block></view><block wx:if="{{$root.g0>0}}"><text data-event-opts="{{[['tap',[['clearCart',['$event']]]]]}}" class="clear" bindtap="__e">清空购物车</text></block></view><block wx:if="{{$root.g1===0}}"><view class="cart-empty"><image class="empty-image" src="/static/products/empty_cart.png" mode="aspectFit"></image><text class="empty-text">购物车还是空的</text></view></block><block wx:else><scroll-view class="cart-list" scroll-y="{{true}}"><block wx:for="{{$root.l3}}" wx:for-item="item" wx:for-index="index" wx:key="id"><view class="cart-item"><image src="{{item.$orig.image}}" mode="aspectFit"></image><view class="item-info"><text class="item-name">{{item.$orig.name}}</text><text class="item-price">{{"￥"+item.$orig.price}}</text></view><view class="quantity-control"><text data-event-opts="{{[['tap',[['removeFromCart',['$0','$1'],[[['cartList','id',item.$orig.id,'categoryIndex']],[['cartList','id',item.$orig.id,'productIndex']]]]]]]}}" class="minus" catchtap="__e">-</text><input class="num" type="digit" data-event-opts="{{[['input',[['handleQuantityInput',['$event','$0','$1'],[[['cartList','id',item.$orig.id,'categoryIndex']],[['cartList','id',item.$orig.id,'productIndex']]]]]],['blur',[['handleQuantityBlur',['$0','$1'],[[['cartList','id',item.$orig.id,'categoryIndex']],[['cartList','id',item.$orig.id,'productIndex']]]]]],['tap',[['',['$event']]]]]}}" value="{{item.$orig.quantity}}" bindinput="__e" bindblur="__e" catchtap="__e"/><text data-event-opts="{{[['tap',[['handleAddToCart',['$0','$1'],[[['cartList','id',item.$orig.id,'categoryIndex']],[['cartList','id',item.$orig.id,'productIndex']]]]]]]}}" class="{{['plus',(item.m8)?'disabled':'']}}" catchtap="__e">+</text></view></view></block></scroll-view></block></view></view></block><block wx:if="{{cartDot.show}}"><view class="cart-dot-wrap"><view class="cart-dot" style="{{'left:'+(cartDot.x+'px')+';'+('top:'+(cartDot.y+'px')+';')+('transform:'+('translate3d('+cartDot.translateX+'px, '+cartDot.translateY+'px, 0)')+';')+('opacity:'+(cartDot.opacity)+';')}}"></view></view></block></view>